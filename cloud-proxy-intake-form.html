
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Policy Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            background-attachment: fixed;
            color: #e8e8e8;
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(42, 42, 66, 0.95) 50%, rgba(26, 26, 46, 0.95) 100%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 122, 204, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        header:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                0 4px 12px rgba(0, 122, 204, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }


        header h1 {
            color: #ffffff;
            margin-bottom: 1rem;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00b4ff 0%, #00d4ff 25%, #7c4dff 75%, #ff6ec7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
            text-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(1.1) saturate(1.2); }
        }

        header p {
            color: #c8d1e0;
            font-size: 1.3rem;
            font-weight: 500;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin: 2rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007acc, #00d4ff);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-section {
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.9) 0%, rgba(45, 45, 70, 0.9) 100%);
            padding: 2.5rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #007acc, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 16px 40px rgba(0, 0, 0, 0.3),
                0 4px 12px rgba(0, 122, 204, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .form-section:hover::before {
            opacity: 1;
        }

        .form-section.full-width {
            grid-column: 1 / -1;
        }

        .form-section h2 {
            color: #ffffff;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .form-section h2::before {
            content: '';
            width: 6px;
            height: 32px;
            background: linear-gradient(135deg, #007acc, #00d4ff);
            border-radius: 3px;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: #e8e8e8;
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: 0.025em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(40, 40, 60, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 
                0 0 0 4px rgba(0, 212, 255, 0.2),
                0 4px 12px rgba(0, 122, 204, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            background: rgba(50, 50, 80, 0.9);
            transform: translateY(-2px) scale(1.01);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            line-height: 1.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .checkbox-item:hover {
            background: #333;
            border-color: #007acc;
            transform: translateY(-2px);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            accent-color: #007acc;
            transform: scale(1.2);
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: #00d4ff;
            font-weight: 600;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 600;
            cursor: pointer;
            color: #e8e8e8;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            justify-content: center;
        }

        .radio-item:hover {
            background: #333;
            border-color: #007acc;
            transform: translateY(-2px);
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 0;
            accent-color: #007acc;
        }

        .radio-item input[type="radio"]:checked + label {
            color: #00d4ff;
            font-weight: 700;
        }

        .radio-item label {
            margin: 0;
            cursor: pointer;
            color: #e8e8e8;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .destinations-section {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            padding: 2rem;
            border-radius: 16px;
            border: 2px solid #444;
            margin-top: 1rem;
        }

        .destinations-section h3 {
            color: #ffffff;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .destinations-section h3::before {
            content: '🎯';
            font-size: 1.5rem;
        }

        .bulk-textarea {
            width: 100%;
            min-height: 240px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 12px;
            color: #ffffff;
            padding: 1.5rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 4px rgba(0, 122, 204, 0.15);
            background: #222;
        }

        .bulk-textarea::placeholder {
            color: #666;
            font-style: italic;
        }

        .destinations-preview {
            max-height: 400px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            scrollbar-width: thin;
            scrollbar-color: #007acc #333;
        }

        .destinations-preview::-webkit-scrollbar {
            width: 8px;
        }

        .destinations-preview::-webkit-scrollbar-track {
            background: #333;
            border-radius: 4px;
        }

        .destinations-preview::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            border-radius: 4px;
        }

        .destinations-counter {
            color: #00d4ff;
            font-weight: 700;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .destinations-counter::before {
            content: '📊';
            font-size: 1.4rem;
        }

        .destination-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #333;
            transition: all 0.3s ease;
        }

        .destination-list-item:hover {
            background: #2a2a2a;
            border-radius: 8px;
            padding-left: 1rem;
            padding-right: 1rem;
            margin: 0 -1rem;
        }

        .destination-list-item:last-child {
            border-bottom: none;
        }

        .destination-list-item span {
            color: #e8e8e8;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.95rem;
            flex: 1;
            font-weight: 500;
        }

        .destination-type-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 1rem;
            color: white;
        }

        .destination-type-badge.url {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
        }

        .destination-type-badge.domain {
            background: linear-gradient(135deg, #007acc, #00d4ff);
        }

        .destination-type-badge.ip {
            background: linear-gradient(135deg, #f57c00, #ff9800);
        }

        .destination-type-badge.subnet {
            background: linear-gradient(135deg, #d73027, #f44336);
        }

        .destination-type-badge.wildcard {
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
        }

        .bulk-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .bulk-stat-item {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid #444;
            text-align: center;
            transition: all 0.3s ease;
        }

        .bulk-stat-item:hover {
            transform: translateY(-2px);
            border-color: #007acc;
        }

        .bulk-stat-item .stat-label {
            color: #b0b0b0;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .bulk-stat-item .stat-value {
            color: #00d4ff;
            font-weight: 800;
            font-size: 1.5rem;
            margin-top: 0.25rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            color: white;
            box-shadow: 0 8px 20px rgba(0, 122, 204, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #005a9e, #007acc);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 122, 204, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a4a4a, #666);
            color: white;
            box-shadow: 0 8px 20px rgba(74, 74, 74, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #666, #777);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(74, 74, 74, 0.4);
        }

        .btn-small {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            min-height: 40px;
        }

        .btn-remove {
            background: linear-gradient(135deg, #d73027, #f44336);
            color: white;
            box-shadow: 0 8px 20px rgba(215, 48, 39, 0.3);
        }

        .btn-remove:hover {
            background: linear-gradient(135deg, #b71c1c, #d73027);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(215, 48, 39, 0.4);
        }

        .btn-add {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
        }

        .btn-add:hover {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(46, 125, 50, 0.4);
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 4rem 0;
            flex-wrap: wrap;
        }

        .actions .btn {
            flex: 1;
            max-width: 200px;
        }

        .preview-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 2.5rem;
            border-radius: 16px;
            border: 2px solid #333;
            margin-top: 3rem;
        }

        .preview-section h2 {
            color: #ffffff;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .preview-section h2::before {
            content: '🚀';
            font-size: 1.5rem;
        }

        .preview-content {
            background: #0a0a0a;
            padding: 2rem;
            border-radius: 12px;
            border: 2px solid #333;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 1rem;
            line-height: 1.7;
            white-space: pre-wrap;
            overflow-x: auto;
            color: #e8e8e8;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.2), rgba(76, 175, 80, 0.2));
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 3rem;
            position: relative;
        }

        .info-box::before {
            content: '💡';
            position: absolute;
            top: 1rem;
            left: 1rem;
            font-size: 1.5rem;
        }

        .info-box h3 {
            color: #4caf50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 700;
            margin-left: 2.5rem;
        }

        .info-box ul {
            color: #e8e8e8;
            margin-left: 4rem;
            line-height: 1.8;
        }

        .required {
            color: #ff6b6b;
            font-weight: 700;
        }

        .hyperlink-section,
        .environment-preview {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #444;
            margin-top: 1.5rem;
        }

        .hyperlink-section h4,
        .environment-preview h4 {
            color: #ffffff;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .hyperlink-preview {
            color: #00d4ff;
            text-decoration: underline;
            cursor: pointer;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 1rem;
            transition: color 0.3s ease;
        }

        .hyperlink-preview:hover {
            color: #007acc;
        }

        .selected-env-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .env-tag {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .env-tag.prod {
            background: linear-gradient(135deg, #d73027, #f44336);
        }

        .env-tag.dev {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
        }

        .env-tag.qa {
            background: linear-gradient(135deg, #f57c00, #ff9800);
        }

        .env-tag {
            background: linear-gradient(135deg, #007acc, #00d4ff);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .actions .btn {
                max-width: 100%;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            animation: fadeInUp 0.6s ease-out;
        }

        .form-section:nth-child(1) { animation-delay: 0.1s; }
        .form-section:nth-child(2) { animation-delay: 0.2s; }
        .form-section:nth-child(3) { animation-delay: 0.3s; }
        .form-section:nth-child(4) { animation-delay: 0.4s; }

        /* Focus states */
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            animation: focusPulse 0.3s ease-out;
        }

        @keyframes focusPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1.01); }
        }

        /* Loading state */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            border: 3px solid #007acc;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(60, 60, 60, 0.3);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .radio-item:hover {
            background: rgba(60, 60, 60, 0.6);
            border-color: #555555;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
            accent-color: #007acc;
        }

        .radio-item label {
            margin: 0;
            cursor: pointer;
            color: #e0e0e0;
            font-weight: 500;
        }

        .environment-preview {
            background-color: #3c3c3c;
            border: 1px solid #555555;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .environment-preview h4 {
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .selected-env-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .env-tag {
            background-color: #007acc;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .env-tag.prod {
            background-color: #d73027;
        }

        .env-tag.dev {
            background-color: #2e7d32;
        }

        .env-tag.qa {
            background-color: #f57c00;
        }

        .destinations-section {
            background-color: #3c3c3c;
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid #555555;
            margin-top: 1rem;
        }

        .destinations-section h3 {
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .destination-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .destination-item input {
            flex: 1;
        }

        .destination-item select {
            width: 150px;
        }

        .bulk-input-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #555555;
        }

        .bulk-input-section h4 {
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .bulk-textarea {
            width: 100%;
            min-height: 150px;
            background-color: #2d2d30;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ffffff;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: #007acc;
        }

        .destinations-preview {
            max-height: 200px;
            overflow-y: auto;
            background-color: #2d2d30;
            border: 1px solid #555555;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .destinations-counter {
            color: #007acc;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .destination-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid #555555;
        }

        .destination-list-item:last-child {
            border-bottom: none;
        }

        .destination-list-item span {
            color: #cccccc;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .hyperlink-section {
            background-color: #3c3c3c;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #555555;
            margin-top: 1rem;
        }

        .hyperlink-section h4 {
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .hyperlink-preview {
            color: #007acc;
            text-decoration: underline;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        .hyperlink-preview:hover {
            color: #005a9e;
        }

        /* Form Validation Styles */
        .form-group {
            position: relative;
        }

        .validation-indicator {
            position: absolute;
            right: 0.75rem;
            top: 2.5rem;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .validation-indicator.valid {
            color: #4caf50;
        }

        .validation-indicator.invalid {
            color: #f44336;
        }

        .form-group input.valid,
        .form-group textarea.valid,
        .form-group select.valid {
            border-color: #4caf50;
            box-shadow: 0 0 0 1px rgba(76, 175, 80, 0.2);
        }

        .form-group input.invalid,
        .form-group textarea.invalid,
        .form-group select.invalid {
            border-color: #f44336;
            box-shadow: 0 0 0 1px rgba(244, 67, 54, 0.2);
        }

        .validation-message {
            font-size: 0.8rem;
            margin-top: 0.25rem;
            transition: all 0.3s ease;
        }

        .validation-message.valid {
            color: #4caf50;
        }

        .validation-message.invalid {
            color: #f44336;
        }

        /* Search/Filter Styles */
        .search-filter-section {
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .search-row {
            display: grid;
            grid-template-columns: 1fr 200px 150px auto;
            gap: 1rem;
            align-items: end;
        }

        .search-input {
            background: #333;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 0.75rem;
            color: #e8e8e8;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .filter-select {
            background: #333;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 0.75rem;
            color: #e8e8e8;
            font-size: 1rem;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #007acc;
        }

        .search-results {
            color: #00d4ff;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .search-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Loading States */
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            backdrop-filter: blur(20px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(139, 195, 74, 0.9));
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.9), rgba(233, 30, 99, 0.9));
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(0, 188, 212, 0.9));
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        /* Enhanced Card Styling */
        .request-card {
            background: linear-gradient(135deg, rgba(42, 42, 66, 0.9) 0%, rgba(55, 55, 85, 0.9) 100%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .request-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #007acc, #00d4ff, #7c4dff);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .request-card:hover {
            transform: translateY(-8px);
            border-color: rgba(0, 212, 255, 0.4);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 8px 16px rgba(0, 122, 204, 0.2);
        }

        .request-card:hover::before {
            transform: translateX(0);
        }

        /* Pulse Animation for Important Elements */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 212, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 212, 255, 0);
            }
        }

        /* Floating Animation for Header */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        header {
            animation: float 6s ease-in-out infinite;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            letter-spacing: 0.025em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.2),
                0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
            transition: transform 0.1s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007acc 0%, #00b4ff 50%, #00d4ff 100%);
            color: white;
            box-shadow: 
                0 4px 15px rgba(0, 122, 204, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0099ff 0%, #00d4ff 50%, #7c4dff 100%);
            box-shadow: 
                0 8px 25px rgba(0, 122, 204, 0.6),
                0 4px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-3px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(90, 90, 120, 0.8) 0%, rgba(110, 110, 140, 0.8) 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(110, 110, 140, 0.9) 0%, rgba(130, 130, 160, 0.9) 100%);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }

        .btn-remove {
            background-color: #d73027;
            color: white;
        }

        .btn-remove:hover {
            background-color: #b71c1c;
        }

        .btn-add {
            background-color: #2e7d32;
            color: white;
        }

        .btn-add:hover {
            background-color: #1b5e20;
        }

        .actions {
            text-align: center;
            margin: 2rem 0;
        }

        .actions .btn {
            margin: 0 0.5rem;
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        .preview-section {
            background-color: #2d2d30;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            margin-top: 2rem;
        }

        .preview-section h2 {
            color: #ffffff;
            margin-bottom: 1rem;
            border-bottom: 2px solid #007acc;
            padding-bottom: 0.5rem;
        }

        .preview-content {
            background-color: #1e1e1e;
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .required {
            color: #f44336;
        }

        .info-box {
            background-color: #1a472a;
            border: 1px solid #2d5a3d;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .info-box h3 {
            color: #4caf50;
            margin-bottom: 0.5rem;
        }

        .info-box ul {
            color: #cccccc;
            margin-left: 1.5rem;
        }

        .hyperlink-preview {
            color: #007acc;
            text-decoration: underline;
            cursor: pointer;
        }

        .hyperlink-preview:hover {
            color: #005a9e;
        }

        /* Tab System Styles */
        .tab-container {
            margin-bottom: 2rem;
        }

        .tab-buttons {
            display: flex;
            background: rgba(42, 42, 66, 0.9);
            border-radius: 16px 16px 0 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            flex: 1;
            padding: 1.25rem 2rem;
            background: transparent;
            border: none;
            color: #b0b0b0;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            overflow: hidden;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 77, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab-button:hover {
            color: #e8e8e8;
            transform: translateY(-1px);
        }

        .tab-button:hover::before {
            opacity: 1;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            color: white;
            box-shadow: 
                0 4px 12px rgba(0, 122, 204, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-button.active::before {
            opacity: 0;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #007acc, #00d4ff);
        }

        .tab-content {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(42, 42, 66, 0.95) 100%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 0 16px 16px;
            padding: 2.5rem;
            min-height: 600px;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Previous Requests Styles */
        .requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .request-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border: 2px solid #444;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .request-card:hover {
            transform: translateY(-4px);
            border-color: #007acc;
            box-shadow: 0 8px 24px rgba(0, 122, 204, 0.2);
        }

        .request-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #007acc, #00d4ff);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .request-card:hover::before {
            transform: translateX(0);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .request-number {
            color: #00d4ff;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .request-date {
            color: #b0b0b0;
            font-size: 0.9rem;
        }

        .request-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-completed {
            color: #4caf50;
        }

        .status-pending {
            color: #ff9800;
        }

        .request-details {
            margin-bottom: 1rem;
        }

        .request-action {
            color: #e8e8e8;
            font-weight: 600;
            text-transform: capitalize;
            margin-bottom: 0.5rem;
        }

        .request-envs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .request-destinations {
            color: #888;
            font-size: 0.85rem;
            font-family: 'SF Mono', monospace;
            line-height: 1.4;
        }

        .no-requests {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .no-requests-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .requests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .requests-count {
            color: #00d4ff;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #4a4a4a, #666);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #666, #777);
            transform: translateY(-2px);
        }

        /* Edit Request Styles */
        .request-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-edit {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #005a9e, #007acc);
            transform: translateY(-1px);
        }

        .btn-status {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-status:hover {
            background: linear-gradient(135deg, #e65100, #f57c00);
            transform: translateY(-1px);
        }

        .status-selector {
            background: #333;
            color: #e8e8e8;
            border: 2px solid #444;
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .status-selector:focus {
            outline: none;
            border-color: #007acc;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn-save {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #666, #777);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: linear-gradient(135deg, #555, #666);
            transform: translateY(-2px);
        }

        .btn-delete {
            background: linear-gradient(135deg, #d73027, #f44336);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #b71c1c, #d73027);
            transform: translateY(-1px);
        }

        .request-type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .request-type-badge.cloud {
            background: linear-gradient(135deg, #007acc, #00d4ff);
            color: white;
        }

        .request-type-badge.onprem {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            color: white;
        }

        @media (max-width: 768px) {
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 1rem;
            }

            .tab-buttons {
                flex-direction: column;
            }

            .tab-button {
                border-radius: 0;
            }

            .requests-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Policy Request Manager</h1>
            <p>Generate properly formatted policy change requests for cloud proxy and on-premises systems</p>
        </header>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('intake')">Cloud Proxy</button>
                <button class="tab-button" onclick="switchTab('onprem')">On-Premises</button>
                <button class="tab-button" onclick="switchTab('history')">Previous Requests</button>
                <button class="tab-button" onclick="switchTab('settings')">⚙️ Settings</button>
            </div>
            
            <div class="tab-content">
                <!-- New Request Tab -->
                <div id="intake-tab" class="tab-pane active">
                    <div class="form-grid">
            <div class="form-section">
                <h2>Request Details & Policy Action</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestNumber">Request Number <span class="required">*</span></label>
                        <input type="text" id="requestNumber" placeholder="REQ001" required>
                    </div>
                    <div class="form-group">
                        <label for="employeeId">Employee ID <span class="required">*</span></label>
                        <input type="text" id="employeeId" placeholder="EMP456" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestDate">Date</label>
                        <input type="date" id="requestDate" readonly style="background: rgba(60, 60, 60, 0.5); cursor: not-allowed;">
                        <small style="color: #888; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Automatically set to today's date</small>
                    </div>
                    <div class="form-group">
                        <label for="snowRequestNumber">SNOW Request Number</label>
                        <input type="text" id="snowRequestNumber" placeholder="Enter SNOW request number after submitting to ServiceNow">
                        <small style="color: #888; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Copy generated request to ServiceNow, then enter the returned request number here</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="jiraUrl">JIRA Base URL</label>
                        <input type="url" id="jiraUrl" placeholder="https://yourorg.atlassian.net" value="https://yourorg.atlassian.net">
                    </div>
                    <div class="form-group">
                        <label for="snowUrl">ServiceNow Base URL</label>
                        <input type="url" id="snowUrl" placeholder="https://yourorg.service-now.com" value="https://yourorg.service-now.com">
                        <small style="color: #888; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Used for creating SNOW request links</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Action Type <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="actionAdd" name="action" value="add" required>
                            <label for="actionAdd">Add</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="actionRemove" name="action" value="remove" required>
                            <label for="actionRemove">Remove</label>
                        </div>
                    </div>
                </div>

                <div class="hyperlink-section">
                    <h4>Request Links Preview</h4>
                    <div style="margin-bottom: 1rem;">
                        <p><strong>JIRA Request:</strong></p>
                        <div id="jiraLinkPreview" class="hyperlink-preview">Complete form to see JIRA link preview</div>
                    </div>
                    <div>
                        <p><strong>ServiceNow Request:</strong></p>
                        <div id="snowLinkPreview" class="hyperlink-preview">Enter SNOW request number to see link preview</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2>AWS Environments</h2>
            <div class="form-group">
                <label>Select Environment(s) <span class="required">*</span></label>
                <p style="color: #cccccc; margin-bottom: 1rem;">Select one or more environments where this policy should be applied:</p>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="envQA" name="environment" value="QA">
                        <label for="envQA">QA</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="envPreCDE" name="environment" value="PreCDE">
                        <label for="envPreCDE">PreCDE</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="envDEV" name="environment" value="DEV">
                        <label for="envDEV">DEV</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="envPROD" name="environment" value="PROD">
                        <label for="envPROD">PROD</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="envCDE" name="environment" value="CDE">
                        <label for="envCDE">CDE</label>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary btn-small" onclick="selectAllEnvironments()">Select All</button>
                    <button type="button" class="btn btn-secondary btn-small" onclick="clearAllEnvironments()">Clear All</button>
                    <button type="button" class="btn btn-secondary btn-small" onclick="selectCommonEnvironments()">Select Common (DEV/QA/PROD)</button>
                </div>
                <div id="environmentsPreview" style="margin-top: 1rem; padding: 1rem; background-color: #3c3c3c; border-radius: 4px; border: 1px solid #555555;">
                    <h4 style="color: #ffffff; margin-bottom: 0.5rem;">Selected Environments:</h4>
                    <div id="selectedEnvironments" style="color: #cccccc; font-style: italic;">None selected</div>
                </div>
            </div>
        </div>

        <div class="form-section full-width">
            <h2>Destinations</h2>
            <div class="destinations-section">
                <h3>Add Destinations</h3>
                <p style="color: #cccccc; margin-bottom: 1rem;">Paste your list of destinations below. Separate with new lines, spaces, or commas. URLs are automatically cleaned and destinations are auto-detected.</p>
                
                <div class="form-group">
                    <label for="bulkDestinations">Destinations List <span class="required">*</span></label>
                    <textarea class="bulk-textarea" id="bulkDestinations" placeholder="Enter destinations (separated by new lines, spaces, or commas):

example.com
*.cdn.example.com, https://api.service.com/v1
192.168.1.0/24 secure.payment.com app.internal.com
staging.test.com" required></textarea>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="clearBulkInput()">Clear Input</button>
                        <button type="button" class="btn btn-secondary" onclick="loadSampleDestinations()">Load Sample</button>
                        <div id="saveIndicator" style="display: flex; align-items: center; color: #2e7d32; opacity: 0; transition: opacity 0.3s ease;">
                            <span style="margin-left: 1rem;">💾 Auto-saving...</span>
                        </div>
                    </div>
                </div>

                <div class="destinations-preview" id="destinationsPreview">
                    <p style="color: #888; font-style: italic;">No destinations added yet. Start typing destinations above to see them processed automatically.</p>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2>Additional Notes</h2>
            <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea id="notes" placeholder="Any additional context, reasoning, or special instructions..."></textarea>
            </div>
        </div>

        <div class="actions">
            <button type="button" class="btn btn-primary" onclick="generateRequest()">Generate Request</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
            <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
            <button type="button" class="btn btn-secondary" onclick="clearDraft()">Clear Draft</button>
        </div>


        <div class="preview-section">
            <h2>Generated Request</h2>
            <div class="preview-content" id="requestPreview">
                Complete the form above and click "Generate Request" to see the formatted output...
            </div>
                    </div>
                </div>

                <!-- On-Premises Tab -->
                <div id="onprem-tab" class="tab-pane">
                    <div class="form-grid">
                        <div class="form-section">
                            <h2>On-Premises Policy Request Details</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="onpremRequestNumber">Request Number <span class="required">*</span></label>
                                    <input type="text" id="onpremRequestNumber" placeholder="ONPREM001" required>
                                </div>
                                <div class="form-group">
                                    <label for="onpremEmployeeId">Employee ID <span class="required">*</span></label>
                                    <input type="text" id="onpremEmployeeId" placeholder="EMP456" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="onpremRequestDate">Date</label>
                                    <input type="date" id="onpremRequestDate" readonly style="background: rgba(60, 60, 60, 0.5); cursor: not-allowed;">
                                    <small style="color: #888; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Automatically set to today's date</small>
                                </div>
                                <div class="form-group">
                                    <label for="onpremSnowRequestNumber">SNOW Request Number</label>
                                    <input type="text" id="onpremSnowRequestNumber" placeholder="Enter SNOW request number after submitting to ServiceNow">
                                    <small style="color: #888; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Copy generated request to ServiceNow, then enter the returned request number here</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="onpremJiraUrl">JIRA Base URL</label>
                                    <input type="url" id="onpremJiraUrl" placeholder="https://yourorg.atlassian.net" value="https://yourorg.atlassian.net">
                                </div>
                                <div class="form-group">
                                    <label for="onpremSnowUrl">ServiceNow Base URL</label>
                                    <input type="url" id="onpremSnowUrl" placeholder="https://yourorg.service-now.com" value="https://yourorg.service-now.com">
                                    <small style="color: #888; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Used for creating SNOW request links</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Action Type <span class="required">*</span></label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="onpremActionAdd" name="onpremAction" value="add" required>
                                        <label for="onpremActionAdd">Add</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="onpremActionRemove" name="onpremAction" value="remove" required>
                                        <label for="onpremActionRemove">Remove</label>
                                    </div>
                                </div>
                            </div>

                            <div class="hyperlink-section">
                                <h4>Request Links Preview</h4>
                                <div style="margin-bottom: 1rem;">
                                    <p><strong>JIRA Request:</strong></p>
                                    <div id="onpremJiraLinkPreview" class="hyperlink-preview">Complete form to see JIRA link preview</div>
                                </div>
                                <div>
                                    <p><strong>ServiceNow Request:</strong></p>
                                    <div id="onpremSnowLinkPreview" class="hyperlink-preview">Enter SNOW request number to see link preview</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Server Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serverName">Server Name/Hostname <span class="required">*</span></label>
                                <input type="text" id="serverName" placeholder="server01.company.com" required>
                            </div>
                            <div class="form-group">
                                <label for="serverIp">Server IP Address <span class="required">*</span></label>
                                <input type="text" id="serverIp" placeholder="192.168.1.100" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serverLocation">Location/Datacenter</label>
                                <input type="text" id="serverLocation" placeholder="DC-East-01">
                            </div>
                            <div class="form-group">
                                <label for="serverOwner">Server Owner/Contact</label>
                                <input type="text" id="serverOwner" placeholder="team@company.com">
                            </div>
                        </div>
                    </div>

                    <div class="form-section full-width">
                        <h2>Firewall Rules</h2>
                        <div class="destinations-section">
                            <h3>Firewall Rule Configuration</h3>
                            <p style="color: #cccccc; margin-bottom: 1rem;">Define the firewall rules for this server. Enter source/destination details, ports, and protocols.</p>
                            
                            <div class="form-group">
                                <label for="onpremFirewallRules">Firewall Rules <span class="required">*</span></label>
                                <textarea class="bulk-textarea" id="onpremFirewallRules" placeholder="Enter firewall rules (one per line):

Source: 192.168.1.0/24 | Destination: 10.0.0.100 | Port: 443 | Protocol: TCP
Source: ANY | Destination: server01.company.com | Port: 80,443 | Protocol: TCP
Source: 10.1.1.0/24 | Destination: 192.168.1.100 | Port: 22 | Protocol: TCP
Source: server02.company.com | Destination: db.company.com | Port: 5432 | Protocol: TCP" required></textarea>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-secondary" onclick="clearOnpremFirewallRules()">Clear Rules</button>
                                    <button type="button" class="btn btn-secondary" onclick="loadSampleFirewallRules()">Load Sample</button>
                                </div>
                            </div>

                            <div class="destinations-preview" id="onpremFirewallPreview">
                                <p style="color: #888; font-style: italic;">No firewall rules added yet. Start typing rules above to see them processed automatically.</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Additional Information</h2>
                        <div class="form-group">
                            <label for="onpremBusinessJustification">Business Justification <span class="required">*</span></label>
                            <textarea id="onpremBusinessJustification" placeholder="Explain the business need for this firewall rule change..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="onpremNotes">Additional Notes</label>
                            <textarea id="onpremNotes" placeholder="Any additional context, special requirements, or instructions..."></textarea>
                        </div>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn btn-primary" onclick="generateOnpremRequest()">Generate Request</button>
                        <button type="button" class="btn btn-secondary" onclick="resetOnpremForm()">Reset Form</button>
                        <button type="button" class="btn btn-secondary" onclick="copyOnpremToClipboard()">Copy to Clipboard</button>
                        <button type="button" class="btn btn-secondary" onclick="clearOnpremDraft()">Clear Draft</button>
                    </div>

                    <div class="preview-section">
                        <h2>Generated On-Premises Request</h2>
                        <div class="preview-content" id="onpremRequestPreview">
                            Complete the form above and click "Generate Request" to see the formatted output...
                        </div>
                    </div>
                </div>

                <!-- Previous Requests Tab -->
                <div id="history-tab" class="tab-pane">
                    <div class="requests-header">
                        <div class="requests-count" id="requestsCount">0 Previous Requests</div>
                        <button class="refresh-btn" onclick="loadPreviousRequests()">🔄 Refresh</button>
                    </div>
                    
                    <!-- Search and Filter Section -->
                    <div class="search-filter-section">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem; font-size: 1.2rem;">🔍 Search & Filter</h3>
                        <div class="search-row">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; color: #e8e8e8;">Search requests</label>
                                <input type="text" id="searchInput" class="search-input" placeholder="Search by request number, employee ID, or notes..." oninput="filterRequests()">
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; color: #e8e8e8;">Filter by status</label>
                                <select id="statusFilter" class="filter-select" onchange="filterRequests()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; color: #e8e8e8;">Filter by type</label>
                                <select id="typeFilter" class="filter-select" onchange="filterRequests()">
                                    <option value="">All Types</option>
                                    <option value="cloud">Cloud</option>
                                    <option value="onprem">On-Premises</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="clearFilters()" style="margin-top: 1.5rem;">Clear Filters</button>
                            </div>
                        </div>
                        <div id="searchResults" class="search-results" style="display: none;"></div>
                    </div>
                    
                    <div id="requestsContainer">
                        <div class="no-requests">
                            <div class="no-requests-icon">📋</div>
                            <h3>No Previous Requests Found</h3>
                            <p>Previous requests will appear here once you start creating them.</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-pane">
                    <div class="form-section">
                        <h2>📁 GitHub Integration</h2>
                        <p style="color: #b0b0b0; margin-bottom: 2rem;">Configure GitHub repository to store your requests as markdown files. This enables sync across devices and version history.</p>
                        
                        <div style="background: #2a2a2a; border: 2px solid #444; border-radius: 12px; padding: 2rem;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="githubRepo">GitHub Repository <span class="required">*</span></label>
                                    <input type="text" id="githubRepo" placeholder="username/repository-name" 
                                           style="font-family: monospace;" 
                                           title="Format: username/repository-name (e.g., john/policy-requests)" required>
                                    <small style="color: #888; display: block; margin-top: 0.25rem;">Format: username/repository-name</small>
                                </div>
                                <div class="form-group">
                                    <label for="githubToken">GitHub Personal Access Token <span class="required">*</span></label>
                                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" 
                                           style="font-family: monospace;" 
                                           title="GitHub Personal Access Token with repo permissions" required>
                                    <small style="color: #888; display: block; margin-top: 0.25rem;">
                                        <a href="https://github.com/settings/tokens" target="_blank" style="color: #007acc;">Create token</a> with 'repo' permissions
                                    </small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="githubBranch">Branch</label>
                                    <input type="text" id="githubBranch" placeholder="main" value="main">
                                </div>
                                <div class="form-group">
                                    <label for="githubPath">Requests Folder Path</label>
                                    <input type="text" id="githubPath" placeholder="requests" value="requests" 
                                           style="font-family: monospace;">
                                    <small style="color: #888; display: block; margin-top: 0.25rem;">Folder in repo where markdown files will be stored</small>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" onclick="testGitHubConnection()">🔍 Test Connection</button>
                                <button type="button" class="btn btn-secondary" onclick="saveGitHubSettings()">💾 Save Settings</button>
                                <button type="button" class="btn btn-secondary" onclick="loadGitHubSettings()">📥 Load Settings</button>
                                <button type="button" class="btn btn-secondary" onclick="enableGitHubStorage()">✅ Enable GitHub Storage</button>
                            </div>
                            
                            <div id="githubStatus" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;">
                                <!-- Status messages will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let destinations = [];
        let duplicateLines = new Set();
        let generatedRequest = '';
        let autoSaveTimer;
        let previousRequests = [];
        let onpremFirewallRules = [];
        let generatedOnpremRequest = '';

        // Progress tracking
        function updateProgress() {
            const fields = [
                document.getElementById('requestNumber').value,
                document.getElementById('employeeId').value,
                document.querySelector('input[name="action"]:checked'),
                document.querySelectorAll('input[name="environment"]:checked').length > 0,
                destinations.length > 0,
                document.getElementById('notes').value
            ];
            
            const completedFields = fields.filter(field => field && field !== '').length;
            const progress = (completedFields / fields.length) * 100;
            
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            return progress;
        }

        // Add progress bar to header
        function addProgressBar() {
            const header = document.querySelector('header');
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-bar';
            progressContainer.innerHTML = '<div class="progress-fill" id="progressBar"></div>';
            header.appendChild(progressContainer);
        }

        // Enhanced auto-save with progress tracking
        function autoSaveDraft() {
            const draftData = {
                requestNumber: document.getElementById('requestNumber').value,
                employeeId: document.getElementById('employeeId').value,
                snowRequestNumber: document.getElementById('snowRequestNumber').value,
                jiraUrl: document.getElementById('jiraUrl').value,
                snowUrl: document.getElementById('snowUrl').value,
                action: document.querySelector('input[name="action"]:checked')?.value,
                environments: Array.from(document.querySelectorAll('input[name="environment"]:checked')).map(cb => cb.value),
                bulkDestinations: document.getElementById('bulkDestinations').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('aws-proxy-request-draft', JSON.stringify(draftData));
            
            // Update progress
            updateProgress();
            
            // Show subtle save indicator
            const saveIndicator = document.getElementById('saveIndicator');
            if (saveIndicator) {
                saveIndicator.innerHTML = '<span style="margin-left: 1rem;">✅ Draft saved</span>';
                saveIndicator.style.opacity = '1';
                setTimeout(() => {
                    saveIndicator.style.opacity = '0';
                }, 2000);
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                transform: translateX(400px);
                transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                min-width: 300px;
            `;
            
            const colors = {
                info: 'linear-gradient(135deg, #007acc, #00d4ff)',
                success: 'linear-gradient(135deg, #2e7d32, #4caf50)',
                error: 'linear-gradient(135deg, #d73027, #f44336)',
                warning: 'linear-gradient(135deg, #f57c00, #ff9800)'
            };
            
            const icons = {
                info: 'ℹ️',
                success: '✅',
                error: '❌',
                warning: '⚠️'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">${icons[type]}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 400);
            }, 4000);
        }

        // Enhanced duplicate detection with better UI
        function updateDuplicateIndicator() {
            let indicator = document.getElementById('duplicateIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'duplicateIndicator';
                indicator.style.cssText = `
                    margin-top: 1rem;
                    padding: 1rem;
                    border-radius: 12px;
                    font-size: 0.95rem;
                    transition: all 0.3s ease;
                    border: 2px solid transparent;
                `;
                document.getElementById('bulkDestinations').parentNode.appendChild(indicator);
            }
            
            if (duplicateLines.size > 0) {
                indicator.style.background = 'linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 193, 7, 0.15))';
                indicator.style.borderColor = '#ff9800';
                indicator.style.color = '#ff9800';
                indicator.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">⚠️</span>
                        <div>
                            <strong>Duplicates Detected</strong>
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">
                                Lines: ${Array.from(duplicateLines).sort((a, b) => a - b).join(', ')}
                            </div>
                            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.25rem;">
                                Duplicates will be automatically removed during processing
                            </div>
                        </div>
                    </div>
                `;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }


        // Load saved draft
        function loadDraft() {
            const savedDraft = localStorage.getItem('aws-proxy-request-draft');
            if (savedDraft) {
                try {
                    const draftData = JSON.parse(savedDraft);
                    
                    // Only load if it's recent (within 7 days)
                    const draftAge = Date.now() - new Date(draftData.timestamp).getTime();
                    if (draftAge < 7 * 24 * 60 * 60 * 1000) {
                        document.getElementById('requestNumber').value = draftData.requestNumber || '';
                        document.getElementById('employeeId').value = draftData.employeeId || '';
                        document.getElementById('snowRequestNumber').value = draftData.snowRequestNumber || '';
                        document.getElementById('jiraUrl').value = draftData.jiraUrl || 'https://yourorg.atlassian.net';
                        document.getElementById('snowUrl').value = draftData.snowUrl || 'https://yourorg.service-now.com';
                        document.getElementById('bulkDestinations').value = draftData.bulkDestinations || '';
                        document.getElementById('notes').value = draftData.notes || '';
                        
                        // Restore action selection
                        if (draftData.action) {
                            document.querySelector(`input[name="action"][value="${draftData.action}"]`).checked = true;
                        }
                        
                        // Restore environment selections
                        if (draftData.environments) {
                            draftData.environments.forEach(env => {
                                const checkbox = document.querySelector(`input[name="environment"][value="${env}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        
                        updateHyperlinkPreview();
                        updateEnvironmentsPreview();
                        highlightDuplicates();
                        
                        // Show draft loaded message
                        const draftAge = Math.floor(draftAge / (1000 * 60 * 60));
                        showNotification(`Draft loaded (saved ${draftAge} hours ago)`, 'success');
                        
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
            return false;
        }

        // Clear draft
        function clearDraft() {
            localStorage.removeItem('aws-proxy-request-draft');
            showNotification('Draft cleared', 'info');
        }

        // Set up auto-save on input changes
        function setupAutoSave() {
            const inputs = [
                'requestNumber', 'employeeId', 'snowRequestNumber', 'jiraUrl', 'snowUrl', 'bulkDestinations', 'notes'
            ];
            
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', () => {
                        clearTimeout(autoSaveTimer);
                        autoSaveTimer = setTimeout(autoSaveDraft, 2000); // Save after 2 seconds of inactivity
                    });
                }
            });
            
            // Also save on radio/checkbox changes
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(autoSaveDraft, 1000);
                });
            });
        }

        // Duplicate detection
        function highlightDuplicates() {
            const textarea = document.getElementById('bulkDestinations');
            const lines = textarea.value.split('\n');
            const seen = new Set();
            const duplicateLineNumbers = new Set();
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim().toLowerCase();
                if (trimmedLine && !trimmedLine.startsWith('#') && !trimmedLine.startsWith('//')) {
                    if (seen.has(trimmedLine)) {
                        duplicateLineNumbers.add(index + 1);
                        // Also mark the first occurrence
                        lines.forEach((checkLine, checkIndex) => {
                            if (checkLine.trim().toLowerCase() === trimmedLine && checkIndex < index) {
                                duplicateLineNumbers.add(checkIndex + 1);
                            }
                        });
                    } else {
                        seen.add(trimmedLine);
                    }
                }
            });
            
            duplicateLines = duplicateLineNumbers;
            updateDuplicateIndicator();
        }

        function updateDuplicateIndicator() {
            let indicator = document.getElementById('duplicateIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'duplicateIndicator';
                indicator.style.cssText = `
                    margin-top: 0.5rem;
                    padding: 0.75rem;
                    border-radius: 6px;
                    font-size: 0.9rem;
                    transition: all 0.3s ease;
                `;
                document.getElementById('bulkDestinations').parentNode.appendChild(indicator);
            }
            
            if (duplicateLines.size > 0) {
                indicator.style.background = 'linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 193, 7, 0.2))';
                indicator.style.border = '1px solid #ff9800';
                indicator.style.color = '#ff9800';
                indicator.innerHTML = `
                    <strong>⚠️ Duplicates Detected:</strong> Lines ${Array.from(duplicateLines).sort((a, b) => a - b).join(', ')}
                    <br><small>Duplicates will be automatically removed during processing</small>
                `;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }




        // Notification system
        function showNotification(message, type = 'info') {
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            const colors = {
                info: 'linear-gradient(135deg, #007acc, #005a9e)',
                success: 'linear-gradient(135deg, #2e7d32, #1b5e20)',
                error: 'linear-gradient(135deg, #d73027, #b71c1c)',
                warning: 'linear-gradient(135deg, #f57c00, #e65100)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 4000);
        }

        // Set today's date and keep it current
        function setTodaysDate() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('requestDate').value = dateString;
        }

        // Initialize with today's date
        setTodaysDate();

        // Update date every minute to ensure it's always current
        setInterval(setTodaysDate, 60000);

        // Auto-generate request number
        function generateRequestNumber() {
            const empId = document.getElementById('employeeId').value;
            if (empId && !document.getElementById('requestNumber').value) {
                const reqNum = `REQ${Date.now().toString().slice(-3)}`;
                document.getElementById('requestNumber').value = reqNum;
                updateHyperlinkPreview();
            }
        }

        // Update hyperlink previews
        function updateHyperlinkPreview() {
            const requestNumber = document.getElementById('requestNumber').value;
            const snowRequestNumber = document.getElementById('snowRequestNumber').value;
            const jiraUrl = document.getElementById('jiraUrl').value;
            const snowUrl = document.getElementById('snowUrl').value;
            const jiraPreview = document.getElementById('jiraLinkPreview');
            const snowPreview = document.getElementById('snowLinkPreview');
            
            // Update JIRA link preview
            if (requestNumber && jiraUrl) {
                const jiraLink = `[${requestNumber}](${jiraUrl}/browse/${requestNumber})`;
                jiraPreview.innerHTML = jiraLink;
                jiraPreview.style.color = '#007acc';
            } else {
                jiraPreview.textContent = 'Complete form to see JIRA link preview';
                jiraPreview.style.color = '#888';
            }
            
            // Update SNOW link preview when number is entered
            if (snowRequestNumber && snowUrl) {
                const snowLink = `[${snowRequestNumber}](${snowUrl}/nav_to.do?uri=task.do?sys_id=${snowRequestNumber})`;
                snowPreview.innerHTML = snowLink;
                snowPreview.style.color = '#007acc';
                snowPreview.style.fontStyle = 'normal';
            } else {
                snowPreview.textContent = 'Enter SNOW request number to see link preview';
                snowPreview.style.color = '#888';
                snowPreview.style.fontStyle = 'italic';
            }
        }

        // Event listeners for hyperlink preview
        document.getElementById('requestNumber').addEventListener('input', updateHyperlinkPreview);
        document.getElementById('jiraUrl').addEventListener('input', updateHyperlinkPreview);
        document.getElementById('snowRequestNumber').addEventListener('input', updateHyperlinkPreview);
        document.getElementById('snowUrl').addEventListener('input', updateHyperlinkPreview);
        document.getElementById('employeeId').addEventListener('blur', generateRequestNumber);

        // Event listeners for environment selection
        document.querySelectorAll('input[name="environment"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateEnvironmentsPreview);
        });

        function selectAllEnvironments() {
            document.querySelectorAll('input[name="environment"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateEnvironmentsPreview();
        }

        function clearAllEnvironments() {
            document.querySelectorAll('input[name="environment"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateEnvironmentsPreview();
        }

        function selectCommonEnvironments() {
            clearAllEnvironments();
            document.getElementById('envDEV').checked = true;
            document.getElementById('envQA').checked = true;
            document.getElementById('envPROD').checked = true;
            updateEnvironmentsPreview();
        }

        function updateEnvironmentsPreview() {
            const selectedEnvs = Array.from(document.querySelectorAll('input[name="environment"]:checked')).map(cb => cb.value);
            const preview = document.getElementById('selectedEnvironments');
            
            if (selectedEnvs.length === 0) {
                preview.innerHTML = '<span style="color: #888; font-style: italic;">None selected</span>';
                return;
            }
            
            const envTags = selectedEnvs.map(env => {
                let className = 'env-tag';
                if (env === 'PROD') className += ' prod';
                else if (env === 'DEV') className += ' dev';
                else if (env === 'QA') className += ' qa';
                
                return `<span class="${className}">${env}</span>`;
            }).join('');
            
            preview.innerHTML = `
                <div class="selected-env-list">
                    ${envTags}
                </div>
                <p style="margin-top: 0.5rem; color: #cccccc; font-size: 0.9rem;">
                    ${selectedEnvs.length} environment(s) selected
                </p>
            `;
        }

        function addDestination() {
            const typeSelect = document.querySelector('.destination-type');
            const valueInput = document.querySelector('.destination-value');
            
            const type = typeSelect.value;
            const value = valueInput.value.trim();
            
            if (value) {
                // Check for duplicates
                if (!destinations.some(dest => dest.value === value)) {
                    destinations.push({ type, value });
                    updateDestinationsPreview();
                    valueInput.value = '';
                } else {
                    alert('This destination has already been added.');
                }
            }
        }

        function processBulkDestinationsAuto() {
            const bulkText = document.getElementById('bulkDestinations').value;
            
            // Split by multiple delimiters: newlines, spaces, commas, and semicolons
            let allItems = [];
            
            // First split by newlines to handle line-by-line input
            const lines = bulkText.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                // Skip empty lines and comments
                if (!line || line.startsWith('#') || line.startsWith('//')) {
                    return;
                }
                
                // Split each line by commas, spaces, tabs, and semicolons
                const items = line.split(/[,\s;]+/).map(item => item.trim()).filter(item => item);
                allItems = allItems.concat(items);
            });
            
            // Clear existing destinations
            destinations = [];
            
            allItems.forEach(item => {
                if (item) {
                    // Strip prefixes that should be removed
                    let cleanedItem = item;
                    
                    // Remove https:// and http:// prefixes
                    if (cleanedItem.startsWith('https://')) {
                        cleanedItem = cleanedItem.substring(8);
                    } else if (cleanedItem.startsWith('http://')) {
                        cleanedItem = cleanedItem.substring(7);
                    }
                    
                    // Remove www. prefix
                    if (cleanedItem.startsWith('www.')) {
                        cleanedItem = cleanedItem.substring(4);
                    }
                    
                    // Remove any path/query parameters (keep only domain/hostname)
                    if (cleanedItem.includes('/') && !cleanedItem.includes('::') && !/\d+\.\d+\.\d+\.\d+\/\d+/.test(cleanedItem)) {
                        cleanedItem = cleanedItem.split('/')[0];
                    }
                    
                    // Auto-detect type based on cleaned content
                    let type = 'domain';
                    if (cleanedItem.startsWith('*.')) {
                        type = 'wildcard';
                    } else if (cleanedItem.includes('/') && (cleanedItem.includes('::') || /\d+\.\d+\.\d+\.\d+\/\d+/.test(cleanedItem))) {
                        type = 'subnet';
                    } else if (/^\d+\.\d+\.\d+\.\d+$/.test(cleanedItem)) {
                        type = 'ip';
                    }
                    
                    // Add unique destinations only (using cleaned item)
                    if (cleanedItem && !destinations.some(dest => dest.value === cleanedItem)) {
                        destinations.push({ type, value: cleanedItem });
                    }
                }
            });
            
            updateDestinationsPreview();
        }
        
        // Legacy function for compatibility (now just calls auto version)
        function processBulkDestinations() {
            processBulkDestinationsAuto();
            
            // Show notification for manual calls
            const count = destinations.length;
            if (count > 0) {
                showNotification(`Processed ${count} destinations`, 'success');
            }
        }

        function removeDestination(index) {
            destinations.splice(index, 1);
            updateDestinationsPreview();
        }

        function clearAllDestinations() {
            if (destinations.length > 0 && confirm('Are you sure you want to remove all destinations?')) {
                destinations = [];
                updateDestinationsPreview();
            }
        }

        function updateDestinationsPreview() {
            const preview = document.getElementById('destinationsPreview');
            
            if (destinations.length === 0) {
                preview.innerHTML = '<p style="color: #888; font-style: italic;">No destinations added yet. Start typing destinations above to see them processed automatically.</p>';
                return;
            }
            
            let html = `<div class="destinations-counter">Total Destinations: ${destinations.length}</div>`;
            
            // Add clear all button
            html += `<div style="margin-bottom: 1rem;">
                <button type="button" class="btn btn-remove btn-small" onclick="clearAllDestinations()">Clear All</button>
            </div>`;
            
            destinations.forEach((dest, index) => {
                html += `
                    <div class="destination-list-item">
                        <span>${dest.value}</span>
                        <button type="button" class="btn btn-remove btn-small" onclick="removeDestination(${index})">Remove</button>
                    </div>
                `;
            });
            
            preview.innerHTML = html;
        }

        function generateRequest() {
            // Get form values
            const requestNumber = document.getElementById('requestNumber').value;
            const employeeId = document.getElementById('employeeId').value;
            const requestDate = document.getElementById('requestDate').value;
            const jiraUrl = document.getElementById('jiraUrl').value;
            const action = document.querySelector('input[name="action"]:checked')?.value;
            const selectedEnvironments = Array.from(document.querySelectorAll('input[name="environment"]:checked')).map(cb => cb.value);
            const notes = document.getElementById('notes').value;

            const snowRequestNumber = document.getElementById('snowRequestNumber').value;
            const snowUrl = document.getElementById('snowUrl').value;
            
            // Validation
            if (!requestNumber || !employeeId || !requestDate || !action) {
                alert('Please fill in all required fields');
                return;
            }

            if (selectedEnvironments.length === 0) {
                alert('Please select at least one environment');
                return;
            }

            if (destinations.length === 0) {
                alert('Please add at least one destination');
                return;
            }

            // Generate the request
            const actionText = action === 'add' ? 'add' : 'remove';
            const directionText = action === 'add' ? 'to' : 'from';
            
            // Format destinations - simple list format
            let destinationsText = destinations.map(dest => dest.value).join('\n');

            // Create hyperlink for JIRA request
            const jiraHyperlink = `[${requestNumber}](${jiraUrl}/browse/${requestNumber})`;
            
            // SNOW request will be generated after submission
            let snowSection = '';
            if (snowRequestNumber && snowRequestNumber.trim()) {
                const snowHyperlink = `[${snowRequestNumber}](${snowUrl}/nav_to.do?uri=task.do?sys_id=${snowRequestNumber})`;
                snowSection = `\nSNOW Request: ${snowHyperlink}`;
            } else {
                snowSection = '\nSNOW Request: [To be generated after submission]';
            }

            // Handle single vs multiple environments
            let proxyText;
            if (selectedEnvironments.length === 1) {
                proxyText = `Proxy: AWS ${selectedEnvironments[0]}`;
            } else {
                proxyText = `Proxy: AWS ${selectedEnvironments.join(', ')}`;
            }

            // Generate the final request in the exact format specified
            const basicRequest = `Approved to ${actionText} ${directionText} the AWS Cloud Proxy
${proxyText}
Destinations:

${destinationsText}

Note: ${notes || 'N/A'}

Date: ${requestDate}

JIRA Request: ${jiraHyperlink}${snowSection}`;

            // Generate the full markdown with additional tracking info
            generatedRequest = `${basicRequest}

---

## Request Details (for internal tracking)
- **Request Number**: ${requestNumber}  
- **Employee ID**: ${employeeId}
- **Action**: ${actionText.charAt(0).toUpperCase() + actionText.slice(1)} ${directionText} AWS Cloud Proxy
- **Environments**: ${selectedEnvironments.join(', ')} (${selectedEnvironments.length} total)
- **Destinations Count**: ${destinations.length}
- **Created**: ${new Date().toISOString().split('T')[0]}

## Environments Breakdown
${selectedEnvironments.map(env => `- **AWS ${env}**: ${actionText} ${destinations.length} destination(s)`).join('\n')}

## Full Destinations List
${destinations.map((dest, index) => `${index + 1}. **${dest.type}**: ${dest.value}`).join('\n')}

${notes ? `## Additional Notes\n${notes}` : ''}

## Implementation Order
${selectedEnvironments.includes('DEV') ? '1. **DEV** - Test implementation first\n' : ''}${selectedEnvironments.includes('QA') ? '2. **QA** - Quality assurance testing\n' : ''}${selectedEnvironments.includes('PreCDE') ? '3. **PreCDE** - Pre-production validation\n' : ''}${selectedEnvironments.includes('PROD') ? '4. **PROD** - Production deployment\n' : ''}${selectedEnvironments.includes('CDE') ? '5. **CDE** - Customer demonstration environment\n' : ''}`;

            // Display the preview (show just the basic format)
            document.getElementById('requestPreview').textContent = basicRequest;
        }

        function resetForm() {
            document.getElementById('requestNumber').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('requestDate').valueAsDate = new Date();
            document.getElementById('notes').value = '';
            document.querySelectorAll('input[name="action"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('input[name="environment"]').forEach(radio => radio.checked = false);
            destinations = [];
            updateDestinationsPreview();
            document.getElementById('requestPreview').textContent = 'Complete the form above and click "Generate Request" to see the formatted output...';
            generatedRequest = '';
        }

        function copyToClipboard() {
            if (!generatedRequest) {
                alert('Please generate a request first');
                return;
            }

            navigator.clipboard.writeText(generatedRequest).then(() => {
                alert('Request copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard. Please select and copy manually.');
            });
        }

        // Load sample destinations
        function loadSampleDestinations() {
            const sampleDestinations = `example.com
*.cdn.example.com
https://api.service.com/v1
192.168.1.0/24
secure.payment.com
app.internal.com
staging.test.com`;
            document.getElementById('bulkDestinations').value = sampleDestinations;
            showNotification('Sample destinations loaded', 'info');
        }

        // Clear bulk input
        function clearBulkInput() {
            document.getElementById('bulkDestinations').value = '';
            destinations = [];
            updateDestinationsPreview();
            showNotification('Input cleared', 'info');
        }

        // Initialize the form
        function initializeForm() {
            // Set up progress bar
            addProgressBar();
            
            // Load any saved draft
            loadDraft();
            
            // Set up auto-save
            setupAutoSave();
            
            // Set up input listeners for real-time updates
            document.getElementById('bulkDestinations').addEventListener('input', function() {
                highlightDuplicates();
                processBulkDestinationsAuto();
            });
            
            // Initialize destinations preview
            updateDestinationsPreview();
            
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeForm);
        
        // Tab System Functions
        function switchTab(tabName) {
            // Remove active class from all tabs and buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            // Add active class to selected tab and button
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Initialize specific tabs
            if (tabName === 'history') {
                loadPreviousRequests();
            } else if (tabName === 'onprem') {
                initializeOnpremForm();
            }
        }

        // Previous Requests Functions
        function loadPreviousRequests() {
            // Simulate loading previous requests from storage/API
            // In a real implementation, this would fetch from your backend
            
            // Load from localStorage or generate mock data
            let storedRequests = localStorage.getItem('aws-proxy-requests');
            if (storedRequests) {
                try {
                    previousRequests = JSON.parse(storedRequests);
                } catch (e) {
                    previousRequests = [];
                }
            } else {
                // Generate some mock data for demonstration
                previousRequests = [
                    {
                        requestNumber: 'REQ089',
                        employeeId: 'EMP456',
                        date: '2025-06-28',
                        action: 'add',
                        environments: ['DEV', 'QA', 'PROD'],
                        destinations: ['api.example.com', '*.cdn.example.com', 'secure.payment.com', 'app.internal.com', 'staging.test.com'],
                        status: 'completed',
                        notes: 'Adding new API endpoints for customer portal'
                    },
                    {
                        requestNumber: 'REQ074',
                        employeeId: 'EMP456',
                        date: '2025-06-15',
                        action: 'remove',
                        environments: ['PROD'],
                        destinations: ['old-api.example.com', 'deprecated.service.com', 'legacy.endpoint.com'],
                        status: 'completed',
                        notes: 'Removing deprecated endpoints'
                    },
                    {
                        requestNumber: 'REQ061',
                        employeeId: 'EMP789',
                        date: '2025-05-30',
                        action: 'add',
                        environments: ['DEV', 'QA'],
                        destinations: ['test.api.com', 'staging.db.com', 'dev.monitoring.com', 'qa.analytics.com'],
                        status: 'pending',
                        notes: 'New monitoring and analytics services'
                    }
                ];
            }
            
            displayPreviousRequests();
        }

        function displayPreviousRequests() {
            const container = document.getElementById('requestsContainer');
            const countElement = document.getElementById('requestsCount');
            
            countElement.textContent = `${previousRequests.length} Previous Requests`;
            
            if (previousRequests.length === 0) {
                container.innerHTML = `
                    <div class="no-requests">
                        <div class="no-requests-icon">📋</div>
                        <h3>No Previous Requests Found</h3>
                        <p>Previous requests will appear here once you start creating them.</p>
                    </div>
                `;
                return;
            }
            
            // Group requests by month and year
            const groupedRequests = {};
            
            previousRequests.forEach(request => {
                const date = new Date(request.date);
                const monthYear = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                
                if (!groupedRequests[monthYear]) {
                    groupedRequests[monthYear] = [];
                }
                groupedRequests[monthYear].push(request);
            });
            
            // Sort month/year groups in descending order (newest first)
            const sortedGroups = Object.keys(groupedRequests).sort((a, b) => {
                const dateA = new Date(a + ' 1');
                const dateB = new Date(b + ' 1');
                return dateB - dateA;
            });
            
            let html = '';
            
            sortedGroups.forEach(monthYear => {
                const requests = groupedRequests[monthYear];
                
                // Sort requests within each group by date (newest first)
                requests.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                html += `
                    <div class="month-group" style="margin-bottom: 3rem;">
                        <div class="month-header" style="
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            margin-bottom: 1.5rem;
                            padding-bottom: 0.75rem;
                            border-bottom: 2px solid #444;
                        ">
                            <h3 style="
                                color: #00d4ff;
                                margin: 0;
                                font-size: 1.5rem;
                                font-weight: 700;
                            ">${monthYear}</h3>
                            <span style="
                                background: linear-gradient(135deg, #007acc, #00d4ff);
                                color: white;
                                padding: 0.25rem 0.75rem;
                                border-radius: 20px;
                                font-size: 0.85rem;
                                font-weight: 600;
                            ">${requests.length} request${requests.length !== 1 ? 's' : ''}</span>
                        </div>
                        
                        <div class="requests-grid">
                `;
                
                requests.forEach(request => {
                    const statusClass = request.status === 'completed' ? 'status-completed' : 'status-pending';
                    const statusIcon = request.status === 'completed' ? '✅' : '⏳';
                    
                    const requestType = request.type || 'cloud'; // Default to cloud for backward compatibility
                    const typeLabel = requestType === 'onprem' ? 'On-Prem' : 'Cloud';
                    
                    html += `
                        <div class="request-card">
                            <div class="request-type-badge ${requestType}">${typeLabel}</div>
                            
                            <div class="request-header" onclick="viewRequestDetails('${request.requestNumber}')" style="cursor: pointer;">
                                <div>
                                    <div class="request-number">${request.requestNumber}</div>
                                    <div class="request-date">${request.date}</div>
                                </div>
                                <div class="request-status ${statusClass}">
                                    <span>${statusIcon}</span>
                                    <span>${request.status}</span>
                                </div>
                            </div>
                            
                            <div class="request-details" onclick="viewRequestDetails('${request.requestNumber}')" style="cursor: pointer;">
                                <div class="request-action">${request.action} operation</div>
                                ${requestType === 'cloud' ? `
                                    <div class="request-envs">
                                        ${request.environments.map(env => `<span class="env-tag ${env.toLowerCase()}">${env}</span>`).join('')}
                                    </div>
                                    <div class="request-destinations">
                                        ${request.destinations.slice(0, 3).join(', ')}${request.destinations.length > 3 ? `... +${request.destinations.length - 3} more` : ''}
                                    </div>
                                ` : `
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>Server:</strong> ${request.serverName || 'N/A'}
                                    </div>
                                    <div class="request-destinations">
                                        ${request.firewallRules ? `${request.firewallRules.length} firewall rule${request.firewallRules.length !== 1 ? 's' : ''}` : 'No rules specified'}
                                    </div>
                                `}
                            </div>
                            
                            <div class="request-actions">
                                <button class="btn-edit" onclick="event.stopPropagation(); editRequest('${request.requestNumber}')">📝 Edit</button>
                                <button class="btn-status" onclick="event.stopPropagation(); toggleStatus('${request.requestNumber}')">${request.status === 'completed' ? '⏳ Mark Pending' : '✅ Mark Complete'}</button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteRequest('${request.requestNumber}')">🗑️ Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function viewRequestDetails(requestNumber) {
            const request = previousRequests.find(req => req.requestNumber === requestNumber);
            if (!request) return;
            
            const requestType = request.type || 'cloud';
            
            // Create a modal or detailed view
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;
            
            let contentHtml = '';
            
            if (requestType === 'cloud') {
                contentHtml = `
                    <div style="margin-bottom: 1rem;">
                        <strong>Employee ID:</strong> ${request.employeeId}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Date:</strong> ${request.date}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Action:</strong> ${request.action}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Environments:</strong> ${request.environments.join(', ')}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Status:</strong> <span style="color: ${request.status === 'completed' ? '#4caf50' : '#ff9800'};">${request.status}</span>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <strong>Destinations:</strong>
                        <div style="background: #333; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; font-family: monospace;">
                            ${request.destinations.join('<br>')}
                        </div>
                    </div>
                    <div>
                        <strong>Notes:</strong>
                        <div style="background: #333; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                            ${request.notes || 'No notes provided'}
                        </div>
                    </div>
                `;
            } else {
                // On-premises request details
                contentHtml = `
                    <div style="margin-bottom: 1rem;">
                        <strong>Employee ID:</strong> ${request.employeeId}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Date:</strong> ${request.date}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Action:</strong> ${request.action}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Status:</strong> <span style="color: ${request.status === 'completed' ? '#4caf50' : '#ff9800'};">${request.status}</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Server Name:</strong> ${request.serverName}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Server IP:</strong> ${request.serverIp}
                    </div>
                    ${request.serverLocation ? `<div style="margin-bottom: 1rem;"><strong>Server Location:</strong> ${request.serverLocation}</div>` : ''}
                    ${request.serverOwner ? `<div style="margin-bottom: 1rem;"><strong>Server Owner:</strong> ${request.serverOwner}</div>` : ''}
                    <div style="margin-bottom: 1.5rem;">
                        <strong>Firewall Rules:</strong>
                        <div style="background: #333; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; font-family: monospace;">
                            ${request.firewallRules ? request.firewallRules.map((rule, index) => {
                                let ruleText = `${index + 1}. Source: ${rule.source} → Destination: ${rule.destination}`;
                                if (rule.port) ruleText += ` | Port: ${rule.port}`;
                                if (rule.protocol) ruleText += ` | Protocol: ${rule.protocol}`;
                                return ruleText;
                            }).join('<br>') : 'No firewall rules specified'}
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Business Justification:</strong>
                        <div style="background: #333; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                            ${request.businessJustification || 'No justification provided'}
                        </div>
                    </div>
                    <div>
                        <strong>Notes:</strong>
                        <div style="background: #333; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                            ${request.notes || 'No notes provided'}
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    border: 2px solid #444;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    color: #e8e8e8;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #00d4ff; margin: 0;">${request.requestNumber} (${requestType === 'cloud' ? 'Cloud' : 'On-Prem'})</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            background: #666;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 32px;
                            height: 32px;
                            cursor: pointer;
                            font-size: 18px;
                        ">×</button>
                    </div>
                    
                    ${contentHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Save request to history when generated
        function saveRequestToHistory() {
            if (!generatedRequest) return;
            
            const requestNumber = document.getElementById('requestNumber').value;
            const employeeId = document.getElementById('employeeId').value;
            const snowRequestNumber = document.getElementById('snowRequestNumber').value;
            const requestDate = document.getElementById('requestDate').value;
            const action = document.querySelector('input[name="action"]:checked')?.value;
            const selectedEnvironments = Array.from(document.querySelectorAll('input[name="environment"]:checked')).map(cb => cb.value);
            const notes = document.getElementById('notes').value;
            
            const newRequest = {
                requestNumber,
                employeeId,
                snowRequestNumber: snowRequestNumber || null, // Will be null until generated
                date: requestDate,
                action,
                environments: selectedEnvironments,
                destinations: destinations.map(dest => dest.value),
                status: 'pending',
                notes,
                type: 'cloud' // Mark as cloud proxy request
            };
            
            // Add to beginning of array
            previousRequests.unshift(newRequest);
            
            // Save to localStorage
            localStorage.setItem('aws-proxy-requests', JSON.stringify(previousRequests));
            
            showNotification('Request saved to history', 'success');
        }

        // Edit request function
        function editRequest(requestNumber) {
            const request = previousRequests.find(req => req.requestNumber === requestNumber);
            if (!request) return;
            
            const requestType = request.type || 'cloud';
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            `;
            
            let formContent = '';
            
            if (requestType === 'cloud') {
                formContent = `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Employee ID:</label>
                        <input type="text" id="editEmployeeId" value="${request.employeeId}" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Action:</label>
                        <select id="editAction" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            cursor: pointer;
                        ">
                            <option value="add" ${request.action === 'add' ? 'selected' : ''}>Add</option>
                            <option value="remove" ${request.action === 'remove' ? 'selected' : ''}>Remove</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status:</label>
                        <select id="editStatus" class="status-selector" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            cursor: pointer;
                        ">
                            <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Environments:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${['QA', 'PreCDE', 'DEV', 'PROD', 'CDE'].map(env => `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #333; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" id="editEnv${env}" ${request.environments && request.environments.includes(env) ? 'checked' : ''} style="accent-color: #007acc;">
                                    <span>${env}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Destinations:</label>
                        <textarea id="editDestinations" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-family: monospace;
                            font-size: 0.9rem;
                            resize: vertical;
                        ">${request.destinations ? request.destinations.join('\\n') : ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Notes:</label>
                        <textarea id="editNotes" style="
                            width: 100%;
                            min-height: 80px;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            resize: vertical;
                        ">${request.notes || ''}</textarea>
                    </div>
                `;
            } else {
                // On-premises request form
                formContent = `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Employee ID:</label>
                        <input type="text" id="editEmployeeId" value="${request.employeeId}" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Action:</label>
                        <select id="editAction" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            cursor: pointer;
                        ">
                            <option value="add" ${request.action === 'add' ? 'selected' : ''}>Add</option>
                            <option value="remove" ${request.action === 'remove' ? 'selected' : ''}>Remove</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status:</label>
                        <select id="editStatus" class="status-selector" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            cursor: pointer;
                        ">
                            <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Server Name:</label>
                        <input type="text" id="editServerName" value="${request.serverName || ''}" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Server IP:</label>
                        <input type="text" id="editServerIp" value="${request.serverIp || ''}" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Server Location:</label>
                        <input type="text" id="editServerLocation" value="${request.serverLocation || ''}" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Server Owner:</label>
                        <input type="text" id="editServerOwner" value="${request.serverOwner || ''}" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Firewall Rules:</label>
                        <textarea id="editFirewallRules" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-family: monospace;
                            font-size: 0.9rem;
                            resize: vertical;
                        " placeholder="Source: X | Destination: Y | Port: Z | Protocol: W">${request.firewallRules ? request.firewallRules.map(rule => {
                            let ruleText = `Source: ${rule.source} | Destination: ${rule.destination}`;
                            if (rule.port) ruleText += ` | Port: ${rule.port}`;
                            if (rule.protocol) ruleText += ` | Protocol: ${rule.protocol}`;
                            return ruleText;
                        }).join('\\n') : ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Business Justification:</label>
                        <textarea id="editBusinessJustification" style="
                            width: 100%;
                            min-height: 80px;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            resize: vertical;
                        ">${request.businessJustification || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Notes:</label>
                        <textarea id="editNotes" style="
                            width: 100%;
                            min-height: 80px;
                            padding: 0.75rem;
                            background: #333;
                            border: 2px solid #444;
                            border-radius: 8px;
                            color: #e8e8e8;
                            font-size: 1rem;
                            resize: vertical;
                        ">${request.notes || ''}</textarea>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
                    border: 2px solid #444;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 700px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    color: #e8e8e8;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #00d4ff; margin: 0;">Edit Request: ${request.requestNumber} (${requestType === 'cloud' ? 'Cloud' : 'On-Prem'})</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            background: #666;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 32px;
                            height: 32px;
                            cursor: pointer;
                            font-size: 18px;
                        ">×</button>
                    </div>
                    
                    ${formContent}
                    
                    <div class="modal-actions">
                        <button class="btn-cancel" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                        <button class="btn-save" onclick="saveEditedRequest('${request.requestNumber}')">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Save edited request
        function saveEditedRequest(requestNumber) {
            const requestIndex = previousRequests.findIndex(req => req.requestNumber === requestNumber);
            if (requestIndex === -1) return;
            
            const request = previousRequests[requestIndex];
            const requestType = request.type || 'cloud';
            
            // Get common edited values
            const employeeId = document.getElementById('editEmployeeId').value;
            const action = document.getElementById('editAction').value;
            const status = document.getElementById('editStatus').value;
            const notes = document.getElementById('editNotes').value;
            
            let updatedRequest = {
                ...previousRequests[requestIndex],
                employeeId,
                action,
                status,
                notes
            };
            
            if (requestType === 'cloud') {
                // Handle cloud request fields
                const destinations = document.getElementById('editDestinations').value.split('\\n').map(d => d.trim()).filter(d => d);
                
                // Get selected environments
                const environments = ['QA', 'PreCDE', 'DEV', 'PROD', 'CDE'].filter(env => 
                    document.getElementById(`editEnv${env}`).checked
                );
                
                updatedRequest.environments = environments;
                updatedRequest.destinations = destinations;
            } else {
                // Handle on-premises request fields
                const serverName = document.getElementById('editServerName').value;
                const serverIp = document.getElementById('editServerIp').value;
                const serverLocation = document.getElementById('editServerLocation').value;
                const serverOwner = document.getElementById('editServerOwner').value;
                const businessJustification = document.getElementById('editBusinessJustification').value;
                
                // Parse firewall rules
                const firewallRulesText = document.getElementById('editFirewallRules').value;
                const firewallRules = [];
                
                if (firewallRulesText.trim()) {
                    const lines = firewallRulesText.split('\\n').map(line => line.trim()).filter(line => line);
                    lines.forEach(line => {
                        const rule = parseFirewallRule(line);
                        if (rule) {
                            firewallRules.push(rule);
                        }
                    });
                }
                
                updatedRequest.serverName = serverName;
                updatedRequest.serverIp = serverIp;
                updatedRequest.serverLocation = serverLocation;
                updatedRequest.serverOwner = serverOwner;
                updatedRequest.businessJustification = businessJustification;
                updatedRequest.firewallRules = firewallRules;
            }
            
            // Update the request
            previousRequests[requestIndex] = updatedRequest;
            
            // Save to localStorage
            localStorage.setItem('aws-proxy-requests', JSON.stringify(previousRequests));
            
            // Refresh display
            displayPreviousRequests();
            
            // Close modal
            document.querySelector('.modal-actions').closest('div').parentElement.remove();
            
            showNotification(`Request ${requestNumber} updated successfully`, 'success');
        }

        // Toggle request status
        function toggleStatus(requestNumber) {
            const requestIndex = previousRequests.findIndex(req => req.requestNumber === requestNumber);
            if (requestIndex === -1) return;
            
            const currentStatus = previousRequests[requestIndex].status;
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            
            previousRequests[requestIndex].status = newStatus;
            
            // Save to localStorage
            localStorage.setItem('aws-proxy-requests', JSON.stringify(previousRequests));
            
            // Refresh display
            displayPreviousRequests();
            
            showNotification(`Request ${requestNumber} marked as ${newStatus}`, 'success');
        }

        // Delete request function
        function deleteRequest(requestNumber) {
            if (confirm(`Are you sure you want to delete request ${requestNumber}? This action cannot be undone.`)) {
                const requestIndex = previousRequests.findIndex(req => req.requestNumber === requestNumber);
                if (requestIndex !== -1) {
                    previousRequests.splice(requestIndex, 1);
                    
                    // Save to localStorage
                    localStorage.setItem('aws-proxy-requests', JSON.stringify(previousRequests));
                    
                    // Refresh display
                    displayPreviousRequests();
                    
                    showNotification(`Request ${requestNumber} deleted successfully`, 'success');
                }
            }
        }

        // Override the original generateRequest function to include saving
        const originalGenerateRequest = generateRequest;
        generateRequest = function() {
            originalGenerateRequest.call(this);
            saveRequestToHistory();
        };

        // On-Premises Functions
        function setOnpremTodaysDate() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('onpremRequestDate').value = dateString;
        }

        function updateOnpremHyperlinkPreview() {
            const requestNumber = document.getElementById('onpremRequestNumber').value;
            const snowRequestNumber = document.getElementById('onpremSnowRequestNumber').value;
            const jiraUrl = document.getElementById('onpremJiraUrl').value;
            const snowUrl = document.getElementById('onpremSnowUrl').value;
            const jiraPreview = document.getElementById('onpremJiraLinkPreview');
            const snowPreview = document.getElementById('onpremSnowLinkPreview');
            
            // Update JIRA link preview
            if (requestNumber && jiraUrl) {
                const jiraLink = `[${requestNumber}](${jiraUrl}/browse/${requestNumber})`;
                jiraPreview.innerHTML = jiraLink;
                jiraPreview.style.color = '#007acc';
                jiraPreview.style.fontStyle = 'normal';
            } else {
                jiraPreview.textContent = 'Complete form to see JIRA link preview';
                jiraPreview.style.color = '#888';
                jiraPreview.style.fontStyle = 'italic';
            }
            
            // Update SNOW link preview when number is entered
            if (snowRequestNumber && snowUrl) {
                const snowLink = `[${snowRequestNumber}](${snowUrl}/nav_to.do?uri=task.do?sys_id=${snowRequestNumber})`;
                snowPreview.innerHTML = snowLink;
                snowPreview.style.color = '#007acc';
                snowPreview.style.fontStyle = 'normal';
            } else {
                snowPreview.textContent = 'Enter SNOW request number to see link preview';
                snowPreview.style.color = '#888';
                snowPreview.style.fontStyle = 'italic';
            }
        }

        function processFirewallRulesAuto() {
            const rulesText = document.getElementById('onpremFirewallRules').value;
            const lines = rulesText.split('\\n').map(line => line.trim()).filter(line => line && !line.startsWith('#') && !line.startsWith('//'));
            
            // Clear existing rules
            onpremFirewallRules = [];
            
            lines.forEach(line => {
                if (line) {
                    // Parse firewall rule format
                    const rule = parseFirewallRule(line);
                    if (rule) {
                        onpremFirewallRules.push(rule);
                    }
                }
            });
            
            updateFirewallRulesPreview();
        }

        function parseFirewallRule(line) {
            // Simple parser for format: Source: X | Destination: Y | Port: Z | Protocol: W
            const parts = line.split('|').map(part => part.trim());
            const rule = {};
            
            parts.forEach(part => {
                if (part.toLowerCase().startsWith('source:')) {
                    rule.source = part.substring(7).trim();
                } else if (part.toLowerCase().startsWith('destination:')) {
                    rule.destination = part.substring(12).trim();
                } else if (part.toLowerCase().startsWith('port:')) {
                    rule.port = part.substring(5).trim();
                } else if (part.toLowerCase().startsWith('protocol:')) {
                    rule.protocol = part.substring(9).trim();
                }
            });
            
            return (rule.source && rule.destination) ? rule : null;
        }

        function updateFirewallRulesPreview() {
            const preview = document.getElementById('onpremFirewallPreview');
            
            if (onpremFirewallRules.length === 0) {
                preview.innerHTML = '<p style="color: #888; font-style: italic;">No firewall rules added yet. Start typing rules above to see them processed automatically.</p>';
                return;
            }
            
            let html = `<div class="destinations-counter">Total Firewall Rules: ${onpremFirewallRules.length}</div>`;
            
            onpremFirewallRules.forEach((rule, index) => {
                html += `
                    <div class="destination-list-item">
                        <div style="flex: 1;">
                            <strong>Rule ${index + 1}:</strong> ${rule.source} → ${rule.destination}
                            ${rule.port ? ` | Port: ${rule.port}` : ''}
                            ${rule.protocol ? ` | Protocol: ${rule.protocol}` : ''}
                        </div>
                    </div>
                `;
            });
            
            preview.innerHTML = html;
        }

        function loadSampleFirewallRules() {
            const sampleRules = `Source: 192.168.1.0/24 | Destination: 10.0.0.100 | Port: 443 | Protocol: TCP
Source: ANY | Destination: server01.company.com | Port: 80,443 | Protocol: TCP
Source: 10.1.1.0/24 | Destination: 192.168.1.100 | Port: 22 | Protocol: TCP
Source: server02.company.com | Destination: db.company.com | Port: 5432 | Protocol: TCP`;
            document.getElementById('onpremFirewallRules').value = sampleRules;
            processFirewallRulesAuto();
            showNotification('Sample firewall rules loaded', 'info');
        }

        function clearOnpremFirewallRules() {
            document.getElementById('onpremFirewallRules').value = '';
            onpremFirewallRules = [];
            updateFirewallRulesPreview();
            showNotification('Firewall rules cleared', 'info');
        }

        function generateOnpremRequest() {
            // Get form values
            const requestNumber = document.getElementById('onpremRequestNumber').value;
            const employeeId = document.getElementById('onpremEmployeeId').value;
            const requestDate = document.getElementById('onpremRequestDate').value;
            const snowRequestNumber = document.getElementById('onpremSnowRequestNumber').value;
            const jiraUrl = document.getElementById('onpremJiraUrl').value;
            const snowUrl = document.getElementById('onpremSnowUrl').value;
            const action = document.querySelector('input[name="onpremAction"]:checked')?.value;
            const serverName = document.getElementById('serverName').value;
            const serverIp = document.getElementById('serverIp').value;
            const serverLocation = document.getElementById('serverLocation').value;
            const serverOwner = document.getElementById('serverOwner').value;
            const businessJustification = document.getElementById('onpremBusinessJustification').value;
            const notes = document.getElementById('onpremNotes').value;

            // Validation
            if (!requestNumber || !employeeId || !requestDate || !action || !serverName || !serverIp || !businessJustification) {
                alert('Please fill in all required fields');
                return;
            }

            if (onpremFirewallRules.length === 0) {
                alert('Please add at least one firewall rule');
                return;
            }

            // Generate the request
            const actionText = action === 'add' ? 'add' : 'remove';
            const directionText = action === 'add' ? 'to' : 'from';
            
            // Format firewall rules
            let firewallRulesText = onpremFirewallRules.map((rule, index) => {
                let ruleText = `${index + 1}. Source: ${rule.source} → Destination: ${rule.destination}`;
                if (rule.port) ruleText += ` | Port: ${rule.port}`;
                if (rule.protocol) ruleText += ` | Protocol: ${rule.protocol}`;
                return ruleText;
            }).join('\\n');

            // Create hyperlinks for request numbers
            const jiraHyperlink = `[${requestNumber}](${jiraUrl}/browse/${requestNumber})`;
            
            let snowSection = '';
            if (snowRequestNumber && snowRequestNumber.trim()) {
                const snowHyperlink = `[${snowRequestNumber}](${snowUrl}/nav_to.do?uri=task.do?sys_id=${snowRequestNumber})`;
                snowSection = `\\nSNOW Request: ${snowHyperlink}`;
            } else {
                snowSection = '\\nSNOW Request: [To be generated after submission]';
            }

            // Generate the final request
            const basicRequest = `Approved to ${actionText} firewall rules ${directionText} the on-premises server

Server Information:
- Server Name: ${serverName}
- IP Address: ${serverIp}${serverLocation ? `\\n- Location: ${serverLocation}` : ''}${serverOwner ? `\\n- Owner/Contact: ${serverOwner}` : ''}

Firewall Rules:
${firewallRulesText}

Business Justification: ${businessJustification}

${notes ? `Additional Notes: ${notes}\\n` : ''}
Date: ${requestDate}

JIRA Request: ${jiraHyperlink}${snowSection}`;

            // Display the preview
            document.getElementById('onpremRequestPreview').textContent = basicRequest;
            generatedOnpremRequest = basicRequest;
            
            // Save to history
            saveOnpremRequestToHistory();
        }

        // Save on-premises request to history
        function saveOnpremRequestToHistory() {
            if (!generatedOnpremRequest) return;
            
            const requestNumber = document.getElementById('onpremRequestNumber').value;
            const employeeId = document.getElementById('onpremEmployeeId').value;
            const snowRequestNumber = document.getElementById('onpremSnowRequestNumber').value;
            const requestDate = document.getElementById('onpremRequestDate').value;
            const action = document.querySelector('input[name="onpremAction"]:checked')?.value;
            const serverName = document.getElementById('serverName').value;
            const serverIp = document.getElementById('serverIp').value;
            const serverLocation = document.getElementById('serverLocation').value;
            const serverOwner = document.getElementById('serverOwner').value;
            const businessJustification = document.getElementById('onpremBusinessJustification').value;
            const notes = document.getElementById('onpremNotes').value;
            
            const newRequest = {
                requestNumber,
                employeeId,
                snowRequestNumber: snowRequestNumber || null,
                date: requestDate,
                action,
                serverName,
                serverIp,
                serverLocation,
                serverOwner,
                businessJustification,
                firewallRules: onpremFirewallRules,
                status: 'pending',
                notes,
                type: 'onprem' // Mark as on-premises request
            };
            
            // Add to beginning of array
            previousRequests.unshift(newRequest);
            
            // Save to localStorage
            localStorage.setItem('aws-proxy-requests', JSON.stringify(previousRequests));
            
            showNotification('On-premises request saved to history', 'success');
        }

        function resetOnpremForm() {
            document.getElementById('onpremRequestNumber').value = '';
            document.getElementById('onpremEmployeeId').value = '';
            document.getElementById('onpremSnowRequestNumber').value = '';
            document.getElementById('serverName').value = '';
            document.getElementById('serverIp').value = '';
            document.getElementById('serverLocation').value = '';
            document.getElementById('serverOwner').value = '';
            document.getElementById('onpremBusinessJustification').value = '';
            document.getElementById('onpremNotes').value = '';
            document.getElementById('onpremFirewallRules').value = '';
            document.querySelectorAll('input[name="onpremAction"]').forEach(radio => radio.checked = false);
            onpremFirewallRules = [];
            updateFirewallRulesPreview();
            document.getElementById('onpremRequestPreview').textContent = 'Complete the form above and click "Generate Request" to see the formatted output...';
            generatedOnpremRequest = '';
            setOnpremTodaysDate();
        }

        function copyOnpremToClipboard() {
            if (!generatedOnpremRequest) {
                alert('Please generate a request first');
                return;
            }

            navigator.clipboard.writeText(generatedOnpremRequest).then(() => {
                alert('On-premises request copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard. Please select and copy manually.');
            });
        }

        function clearOnpremDraft() {
            localStorage.removeItem('onprem-request-draft');
            showNotification('On-premises draft cleared', 'info');
        }

        // Event listeners for on-premises form
        function setupOnpremEventListeners() {
            // Set today's date for on-premises form
            setOnpremTodaysDate();
            
            // Update hyperlink previews
            document.getElementById('onpremRequestNumber').addEventListener('input', updateOnpremHyperlinkPreview);
            document.getElementById('onpremSnowRequestNumber').addEventListener('input', updateOnpremHyperlinkPreview);
            document.getElementById('onpremJiraUrl').addEventListener('input', updateOnpremHyperlinkPreview);
            document.getElementById('onpremSnowUrl').addEventListener('input', updateOnpremHyperlinkPreview);
            
            // Process firewall rules in real-time
            document.getElementById('onpremFirewallRules').addEventListener('input', processFirewallRulesAuto);
        }

        // Initialize on-premises form when tab is first opened
        function initializeOnpremForm() {
            if (!document.getElementById('onpremRequestDate').value) {
                setupOnpremEventListeners();
            }
        }

        // Form Validation Functions
        function validateField(element, validationRules) {
            const value = element.value.trim();
            const fieldGroup = element.closest('.form-group');
            
            // Remove existing validation elements
            const existingIndicator = fieldGroup.querySelector('.validation-indicator');
            const existingMessage = fieldGroup.querySelector('.validation-message');
            if (existingIndicator) existingIndicator.remove();
            if (existingMessage) existingMessage.remove();
            
            // Reset classes
            element.classList.remove('valid', 'invalid');
            
            let isValid = true;
            let message = '';
            
            // Run validation rules
            for (const rule of validationRules) {
                if (!rule.test(value, element)) {
                    isValid = false;
                    message = rule.message;
                    break;
                }
            }
            
            // Add validation indicator
            const indicator = document.createElement('span');
            indicator.className = `validation-indicator ${isValid ? 'valid' : 'invalid'}`;
            indicator.textContent = isValid ? '✓' : '✗';
            fieldGroup.appendChild(indicator);
            
            // Add validation message if invalid
            if (!isValid && message) {
                const messageElement = document.createElement('div');
                messageElement.className = `validation-message invalid`;
                messageElement.textContent = message;
                fieldGroup.appendChild(messageElement);
            }
            
            // Add classes
            element.classList.add(isValid ? 'valid' : 'invalid');
            
            return isValid;
        }
        
        function setupFormValidation() {
            const validationRules = {
                requestNumber: [
                    { test: v => v.length > 0, message: 'Request number is required' },
                    { test: v => v.length >= 3, message: 'Request number must be at least 3 characters' }
                ],
                employeeId: [
                    { test: v => v.length > 0, message: 'Employee ID is required' },
                    { test: v => v.length >= 3, message: 'Employee ID must be at least 3 characters' }
                ],
                serverName: [
                    { test: v => v.length > 0, message: 'Server name is required' },
                    { test: v => v.length >= 3, message: 'Server name must be at least 3 characters' }
                ],
                serverIp: [
                    { test: v => v.length > 0, message: 'Server IP is required' },
                    { test: v => /^(\d{1,3}\.){3}\d{1,3}$/.test(v) || /^[a-f0-9:]+$/i.test(v), message: 'Enter a valid IP address' }
                ],
                onpremBusinessJustification: [
                    { test: v => v.length > 0, message: 'Business justification is required' },
                    { test: v => v.length >= 10, message: 'Please provide a detailed justification (at least 10 characters)' }
                ]
            };
            
            // Add event listeners for validation
            Object.keys(validationRules).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('blur', () => {
                        validateField(element, validationRules[fieldId]);
                    });
                    element.addEventListener('input', () => {
                        // Real-time validation for some fields
                        if (['requestNumber', 'employeeId'].includes(fieldId)) {
                            validateField(element, validationRules[fieldId]);
                        }
                    });
                }
            });
            
            // On-premises form validation
            const onpremFields = ['onpremRequestNumber', 'onpremEmployeeId'];
            onpremFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('blur', () => {
                        const baseFieldId = fieldId.replace('onprem', '').replace(/^[A-Z]/, match => match.toLowerCase());
                        if (validationRules[baseFieldId]) {
                            validateField(element, validationRules[baseFieldId]);
                        }
                    });
                }
            });
        }
        
        // Search and Filter Functions
        let allRequests = [];
        let filteredRequests = [];
        
        function filterRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredRequests = allRequests.filter(request => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    request.requestNumber.toLowerCase().includes(searchTerm) ||
                    request.employeeId.toLowerCase().includes(searchTerm) ||
                    (request.notes && request.notes.toLowerCase().includes(searchTerm)) ||
                    (request.businessJustification && request.businessJustification.toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = !statusFilter || request.status === statusFilter;
                
                // Type filter
                const requestType = request.type || 'cloud';
                const matchesType = !typeFilter || requestType === typeFilter;
                
                return matchesSearch && matchesStatus && matchesType;
            });
            
            // Update results info
            updateSearchResults();
            
            // Display filtered requests
            displayFilteredRequests();
        }
        
        function updateSearchResults() {
            const resultsElement = document.getElementById('searchResults');
            const totalCount = allRequests.length;
            const filteredCount = filteredRequests.length;
            
            if (totalCount === 0) {
                resultsElement.style.display = 'none';
                return;
            }
            
            resultsElement.style.display = 'block';
            
            if (filteredCount === totalCount) {
                resultsElement.textContent = `Showing all ${totalCount} requests`;
            } else {
                resultsElement.textContent = `Showing ${filteredCount} of ${totalCount} requests`;
            }
        }
        
        function displayFilteredRequests() {
            const container = document.getElementById('requestsContainer');
            const countElement = document.getElementById('requestsCount');
            
            // Update count
            countElement.textContent = `${filteredRequests.length} Previous Requests`;
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="no-requests">
                        <div class="no-requests-icon">🔍</div>
                        <h3>No Requests Found</h3>
                        <p>Try adjusting your search or filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Use the existing display logic but with filtered requests
            const originalRequests = previousRequests;
            previousRequests = filteredRequests;
            displayPreviousRequests();
            previousRequests = originalRequests;
        }
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            
            filteredRequests = [...allRequests];
            updateSearchResults();
            displayFilteredRequests();
        }
        
        // Override loadPreviousRequests to initialize search/filter
        const originalLoadPreviousRequests = loadPreviousRequests;
        loadPreviousRequests = function() {
            originalLoadPreviousRequests.call(this);
            
            // Store all requests for filtering
            allRequests = [...previousRequests];
            filteredRequests = [...allRequests];
            
            // Update search results
            updateSearchResults();
        };
        
        // GitHub Integration Functions
        let githubConfig = {};
        let storageMode = 'localStorage'; // Default to localStorage
        
        function saveGitHubSettings() {
            githubConfig = {
                repo: document.getElementById('githubRepo').value,
                token: document.getElementById('githubToken').value,
                branch: document.getElementById('githubBranch').value || 'main',
                path: document.getElementById('githubPath').value || 'requests'
            };
            
            localStorage.setItem('github-config', JSON.stringify(githubConfig));
            showGitHubStatus('Settings saved successfully!', 'success');
        }
        
        function loadGitHubSettings() {
            const saved = localStorage.getItem('github-config');
            if (saved) {
                githubConfig = JSON.parse(saved);
                document.getElementById('githubRepo').value = githubConfig.repo || '';
                document.getElementById('githubToken').value = githubConfig.token || '';
                document.getElementById('githubBranch').value = githubConfig.branch || 'main';
                document.getElementById('githubPath').value = githubConfig.path || 'requests';
                showGitHubStatus('Settings loaded successfully!', 'success');
            } else {
                showGitHubStatus('No saved settings found.', 'info');
            }
        }
        
        async function testGitHubConnection() {
            if (!githubConfig.repo || !githubConfig.token) {
                showGitHubStatus('Please enter repository and token first.', 'error');
                return;
            }
            
            showGitHubStatus('Testing connection...', 'info');
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const repo = await response.json();
                    showGitHubStatus(`✅ Connected to ${repo.full_name} successfully!`, 'success');
                } else {
                    const error = await response.json();
                    showGitHubStatus(`❌ Connection failed: ${error.message}`, 'error');
                }
            } catch (error) {
                showGitHubStatus(`❌ Connection error: ${error.message}`, 'error');
            }
        }
        
        function showGitHubStatus(message, type) {
            const statusDiv = document.getElementById('githubStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = `github-status ${type}`;
            statusDiv.textContent = message;
            
            // Style based on type
            if (type === 'success') {
                statusDiv.style.background = '#1a472a';
                statusDiv.style.border = '1px solid #2d5a3d';
                statusDiv.style.color = '#4caf50';
            } else if (type === 'error') {
                statusDiv.style.background = '#4a1a1a';
                statusDiv.style.border = '1px solid #5a2d2d';
                statusDiv.style.color = '#f44336';
            } else {
                statusDiv.style.background = '#1a3a4a';
                statusDiv.style.border = '1px solid #2d4a5a';
                statusDiv.style.color = '#2196f3';
            }
            
            // Auto-hide after 5 seconds for success/info messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        async function createMarkdownFile(request) {
            const requestType = request.type || 'cloud';
            const date = new Date(request.date);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0') + '-' + date.toLocaleDateString('en-US', { month: 'long' });
            
            // Generate filename
            const filename = `${request.requestNumber}-${requestType}-${request.date}.md`;
            const filePath = `${githubConfig.path}/${year}/${month}/${filename}`;
            
            // Generate markdown content
            let markdownContent = '';
            
            if (requestType === 'cloud') {
                markdownContent = `---
requestNumber: ${request.requestNumber}
employeeId: ${request.employeeId}
type: cloud
status: ${request.status}
date: ${request.date}
action: ${request.action}
environments: [${request.environments.join(', ')}]
---

# Cloud Proxy Policy Request: ${request.requestNumber}

**Employee ID:** ${request.employeeId}  
**Date:** ${request.date}  
**Action:** ${request.action}  
**Status:** ${request.status}  

## Environments
${request.environments.map(env => `- ${env}`).join('\\n')}

## Destinations
${request.destinations.map(dest => `- ${dest}`).join('\\n')}

${request.notes ? `## Notes\n${request.notes}` : ''}

---
*Generated by Policy Request Manager*`;
            } else {
                markdownContent = `---
requestNumber: ${request.requestNumber}
employeeId: ${request.employeeId}
type: onprem
status: ${request.status}
date: ${request.date}
action: ${request.action}
serverName: ${request.serverName}
serverIp: ${request.serverIp}
---

# On-Premises Firewall Request: ${request.requestNumber}

**Employee ID:** ${request.employeeId}  
**Date:** ${request.date}  
**Action:** ${request.action}  
**Status:** ${request.status}  

## Server Information
- **Server Name:** ${request.serverName}
- **IP Address:** ${request.serverIp}
${request.serverLocation ? `- **Location:** ${request.serverLocation}` : ''}
${request.serverOwner ? `- **Owner:** ${request.serverOwner}` : ''}

## Firewall Rules
${request.firewallRules ? request.firewallRules.map((rule, index) => {
    let ruleText = `${index + 1}. Source: ${rule.source} → Destination: ${rule.destination}`;
    if (rule.port) ruleText += ` | Port: ${rule.port}`;
    if (rule.protocol) ruleText += ` | Protocol: ${rule.protocol}`;
    return ruleText;
}).join('\\n') : 'No firewall rules specified'}

## Business Justification
${request.businessJustification || 'No justification provided'}

${request.notes ? `## Additional Notes\n${request.notes}` : ''}

---
*Generated by Policy Request Manager*`;
            }
            
            return { filePath, markdownContent };
        }
        
        async function saveRequestToGitHub(request) {
            if (!githubConfig.repo || !githubConfig.token) {
                throw new Error('GitHub not configured. Please go to Settings tab.');
            }
            
            const { filePath, markdownContent } = await createMarkdownFile(request);
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add ${request.requestNumber} - ${request.type || 'cloud'} request`,
                        content: btoa(unescape(encodeURIComponent(markdownContent))),
                        branch: githubConfig.branch
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message);
                }
                
                return await response.json();
            } catch (error) {
                console.error('GitHub save error:', error);
                throw error;
            }
        }
        
        function enableGitHubStorage() {
            if (!githubConfig.repo || !githubConfig.token) {
                showGitHubStatus('Please configure and test GitHub connection first.', 'error');
                return;
            }
            
            storageMode = 'github';
            localStorage.setItem('storage-mode', storageMode);
            showGitHubStatus('✅ GitHub storage enabled! New requests will be saved to GitHub.', 'success');
        }
        
        // Initialize form validation when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupFormValidation();
            loadGitHubSettings();
            
            // Load storage mode
            const savedMode = localStorage.getItem('storage-mode');
            if (savedMode) {
                storageMode = savedMode;
            }
        });
        
        // Legacy initialize call for compatibility
        updateDestinationsPreview();
    </script>
</body>
</html>